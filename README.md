### 项目名称 imginit

#### 项目说明

    本项目提供Dockerfile文件及相关资源文件用于构建新的基于centos7:latest版本的
    容器镜像imginit用于进一步构建目标应用镜像,不同的目标应用镜像可基于此集成一种或
    多种相关服务程序及配置文件以实现特定的应用功能.期望以此种构建方式为常规功能测试
    和服务部属提供适用环境和快速启动方案.
    
#### 镜像和服务

###  
    镜像imginit是在hub.docker.com官方的centos7容器镜像基础上添加了基础环境
    配置,支持服务及目标服务管理方案,且能够在容器启动后执行容器环境初始化过程,以
    指定方式启动目标服务程序并保障其运行.镜像imginit设计作为基础镜像使用,它本身
    不包含任何应用服务,默认不启动任何目标服务程序,但为开发调式目的,镜像imginit中
    默认包含了数个支持服务.
    
    目标应用镜像将以imginit为基础,以特定的应用服务为目标,进一步添加必要的服务程
    序和配置及数据文件,生成单一的功能服务镜像用于部属分发.基于镜像imginit中提供
    的功能,用户和管理员可通过环境变量和特定的功能配置文件指示具体的容器初始环境配
    置及目标服务运行方式.如果应用服务启动过程支持,亦可通过环境变量和功能配置文件
    提供目标应用配置参数.
    
    单个目标应用镜像可以添加多种相互独立的目标服务并能根据启动参数的指示分别启动各服
    务到各自的容器实例.更为常用的方法是集成主要服务和相关的附加或支持服务到同一目标
    应用镜像以便于应用的同步分发部属或为主要服务启用附加和支持功能.这在某些基于微服
    务架构的项目开发中或许比较适用.
    
    通常情况下,用户和管理员需要以此类镜像作为基础构建新应用镜像来添加适用的功能
    配置文件和目标服务相关的资源文件,在开发和测试过程中也可通过挂载数据卷到特定
    位置的方式提供服务相关文件.

###  
    每一种构件于镜像imginit的具备独立功能的应用服务,即目标服务,需要在"/srv"目
    录下创建以服务名称命名的子目录作为该应用服务的资源配置和工作目录,即目标服务配置
    目录,该目录用于存放目标服务的功能配置文件(文件名:workcfg.json,主要用于提默认
    供初始化程序对当前应用环境的配置参数),目标服务启动程序,功能程序,应用服务配置文件
    及其它资源文件,必要时还可在此提供命称为"init.sh"的自定义初始化程序来代默认初始
    化程序执行容器环境配置过程.
    
    本项目的兄弟项目包括了数个常用目标应用镜像示例,可直接启动一个运行对应服务的容器
    实例,其配置文件和资源文件仅作为模板用于测试和演示目的,具体用法和配置说明请参考对
    应目标服务配置目录下的说明文档.
    
    功能配置文件"workcfg.json"位于目标服务目录,内容为由单一JSON对象构成地配置数
    据,其属性值提供当前服务运行适用的容器初始化参数.参数缺失或参数值失效时初始化过
    程将使用缺省值或放弃相关功能的启用配置.目标服务亦可于此定义和添加额外的配置项以
    便为目标服务的启动和配置提供参数.

###  
    支持服务在本项目中提供并先于目标服务启动,且在服务保障情况下目标服务重启前总会
    执行支持服务重启,但该重启过程不会重启状态正常且配置参数未发生变更的支持服务.
    此外在状态检测周期中会执行支持服务保活测试,测试过程会使用新的配置参数重启已配置
    为启用但运行状态测试失败的支持服务.
    
    目标服务程序可以三种方式被启动运行: 非守护运行,守护运行和状态检测运行.其后两种
    运行方式是在初始化程序的服务保障过程下运行,服务状态失败会触发服务重启过程,这两
    种方式下启动目标服务程序后会延时指定时间即服务重启间隔,以保证服务实例在首次被
    检测前进入正常工作状态工作,同时也可防止由于配置异常造成的循环处理占用过多系统
    资源(如目标服务程序未能启动或未能以前台方式运行).
    
    状态检测运行方式还提供了简易服务控制命令"srvctl restart"和"srvctl stop"用于该
    运行方式下强制服务保障过程执行服务重启和终止操作.
    
    当前容器启动后的服务重启计数会记录在"./service.run.count"文件中,启动计数仅记累
    计最近一次容器启动后的服务重启次数.
    
###  
    服务运行方式:
    
    01. 非守护运行
        
        最简单的情况就是非守护运行方式,如果属性"workwatch"的值不是一个有效的非负整
        数,那么初始化程序将以非守护方式启动目标服务程序,此时目标服务程序将直接被启动
        为容器的init进程运行,其进程一但终止运行则将导致当前容器终止,这比较适用于容器
        编排和其它服务管理方式.
        
    02. 守护运行
        
        若属性"workwatch"的值为0,初始化程序将以守护方式启动目标服务程序,使能够在 
        目标服务程序终止后执行重启.目标服务程序可以是期望的功能程序或目标服务启动
        程序,目标服务启动程序目的仅为功能服务程序的启动执行环境配置及安全检查,并在
        其配置和检查工作完成时必须以exec()的方式启动目标服务程序到前台运行,daemon
        方式启动用的目标服务程序将会被认为是"服务进程已终止",这将导致初始化程序守
        护功能尝试重新解析功能配置数据和设置容器环境并重启目标服务程序.该方式适用
        于单进程服务程序的监护管理.
    
    03. 状态检测运行
    
        属性"workwatch"的值为正整数时指示初始化程序执行另一种服务监视方式,即状态
        检测运行方式,此种方式允许目标服务程序运行在后台并且可以同时启动多个服务相
        关的进程执行功能,初始化程序将在后台启动目标服务程序或目标服务启动程序,之后
        则会周期性执行特定的程序集并参考其返回状态确定下一步操作,程序集执行周期为
        属性"workwatch"指示的秒数.
        
        检测周期开始后最先执行例行任务程序集,路径为"./PeriodicRT-*",一般为shell脚
        本,每周期无条件后台执行,用于完成服务或容器相关的例行操作.
        
        随即,服务状态测试程序集"./PeriodicST-*"被执行,一般为shell脚本,可通过测试各
        服务进程的运行状态和查询其它运行时参数来确定目标服务是否处于可用状态,程序
        无参执行,任一程序返回值非0时指示服务状态失败,将导致初始化程序立即重新执行容
        器环境配置和目标服务启动过程.
        
        如果服务状态通过检测则认为当前服务运行状态良好,则服务保障过程会在当前检测周
        期执行维护任务程序集,其路径为"./PeriodicMT-*",后台执行,可用于执行服务状态
        注册和统计数据更新等服务状态相关的附加任务.
        
        服务状态检测周期总是在目标服务程序启动后的一个"服务重启间隔"时长后开始,如果
        状态检测及附加任务持续时间较长,需要相关功能程序自行处理实例重入问题.
        
        指定了状态检测运行方式但不存在可用的状态测试程序时初始化程序将放弃对目标服
        务的状态测试(认为服务总处于可用状态)直到状态测试程序可用.
    
#### 镜像imginit构建内容
    
    01. 应用软件: man which ipset sqlite3 inotify-tools iproute psmisc libpcap \
                  sysvinit-tools nmap-ncat dropbear sshpass jq ppp unzip
    
    02. 功能配置: 基本防火墙规则管理
    
    03. 支持服务: SSH服务支持(含sftp), PPPOE拨号支持
    
    04. 服务管理: 直接启动(非保障方式),服务进程守护,服务状态检测

#### 初始化过程说明

    容器无参启动时会执行默认初始化程序"/srv/imginit/initstart.sh"开始初始化过程.
    
    具体初始化步骤如下:
    
    00. 目标服务确定:
        
        根据环境变量"$SRVNAME"确定并切换至目标服务工作目录(通常为"/srv/$SRVNAME")
        并执行后继功能.
        
        目标服务目录确定或切换失败时将使用前目录"/srv/imginit"作为目标服务目录.
        
        目录切换失败会使容器在重新启动时再次尝试确定目标服务目录.
        
    01. 自定义初始化过程:
        
        测试目标服务配置目录若存在用户自定义的初始化程序"./init.sh"则转到用户初始
        化程序执行以代替当前初始化过程.
        
    02. 环境配置参数提取:
        
        容器首次启动时默认初始化过程优先从环境变量"$SRVCFG"提取初始化配置数据,并
        同步写入到功能配置文件"./workcfg.json".
        
        环境变量"$SRVCFG"未能提供任何配置数据或容器在重启动时将直接读取功能配置文
        件"./workcfg.json"的内容作为配置数据.
        
        基于上述,可在容器启动时挂载数据卷到"/srv/<$SRVNAME>"来提供容器配置数据.
        
        若提供的配置数据并非期望格式则使用缺省配置数据执行初始化过程并输出容器错
        误日志以示提醒.
        
        检查功能配置信息的可用性及内容格式,提取配置参数备用,配置项参数缺失或提取
        失败时将使用缺省值.
        
    03. 初始化延时:
        
        确定延时时间并执行延时操作.这通常用于等待容器后继资源配置的完成,如附加额
        外的网络接口到已启动容器.
        
    04. 基本防火墙规则配置:
        
        完全接管容器的入站和转发流量通行权限,默认规则为: 除指定的协议及端口外,禁
        行所有的入站和转发流量.
        
        如无法通过功能配置信息完成期望的防火墙配置则需要服务启动或运行期间自行配
        置防火墙状态,filter表预置链SRVLCH和SRVFWD可分别用于入站流量和转发流量的过
        滤,nat表预置链SRVDNAT和SRVSNAT则用于添加服务相关的路由转发规则,此外还配置
        了mangle表预置链SRVMFW和SRVMPE用于执行相应位置的MANGLE操作.
        
    05. SSH服务配置:
        
        根据指示以目标参数启动ssh服务,如果确定SSH服务开启,则需要同时提供服务端口
        和容器内root用户密码参数.
        
        除非必要,不建议开启,该服务应仅用于测试或收集容器运行状态等特殊情况.启用
        SSH服务会在防火墙同步打开相关的服务端口,已配置支持sftp服务.
        
    06. OPENVPN接入配置:    
        
        根据启用指示和服务参数启动一个OPENVPN服务进程以执行远程接入.
        
        仅可使用用账户名称及密码作为接入凭据,不支持对远程用户进行路由转发.
        
        接入账户配置: 文件"../imginit/ovpn/pwd/<账户名>.pwd"首行存储用户密码串.
        
        容器未配置提供拨号服务的网络接口或者指定的接口无效时将放弃拨号服务,PPPOE
        拨号成功时可根据指示接管容器系统的默认路由并启用对端DNS配置.
    
    07. 目标服务启动:
    
        初始化程序在完成前述所有初始化配置工作后按照指定的方式执行指定的shell命令
        串来启动目标服务后进行服务保障过程.
        
        用户需要通过配置数据提供目标服务启动的shell命令.命令串缺失将使用内部延时过
        程执行延时后重试,固定延时周期为600秒.命令串可执行测试失败时将使用延时程序
        "DoNothing"(即"sleep 600")作为目标服务程序执行.使用延时目的是为了保证当前
        容器在服务启动错误发生后不会立即终止运行,以方便进行程序调试和配置修正工作,
        并可能在随后手动终止延时过程以使初始化程序尝试重新设置容器环境和启动目标服
        务程序.
        
#### 功能配置参数说明

    配置参数生效条件:
    
    00. 配置数据内容为合法JSON格式.
    01. 参数属性在对象中存在.
    02. 参数值类型和取值范围在当前环境下有效.
    
    默认初始化过程相关参数定义:
    
    01. initdelay   正整数,指示初始化延时时间,单位秒,缺省值3,仅容器启动时使用.
    02. workstart   初始化完成后用于启动目标服务程序的shell命令串.
    03. workwatch   值为非负整数时指示以守护或状态检测方式启动目标服务进程.
    04. workintvl   正整数,指示在服务失败后执行重启目标服务程序前的延时时间.
    
    05. firewall            简单防火墙配置对象.
    06. firewall.tcpportpmt 指定开放的TCP端口范围,如: 80:86,125,8080,缺省无.
    07. firewall.udpportpmt 指定开放的UDP端口范围,如: 80:86,125,8080,缺省无.
    08. firewall.icmppermit 值为"yes"时允许ICMP协议入站,缺省"no".
    09. firewall.igmppermit 值为"yes"时允许IGMP协议入站,缺省"no".
    10. firewall.grepermit  值为"yes"时允许GRE协议入站,缺省"no".
    11. firewall.esppermit  值为"yes"时允许ESP协议入站,缺省"no".
    12. firewall.ahpermit   值为"yes"时允许AH协议入站,缺省"no".
    
    13. sshsrv              SSH服务配置对象.
    14. sshsrv.enable       值为"yes"时指示启用SSH服务,缺省"no".
    15. sshsrv.sshport      正整数,指定SSH服务使用的端口号,缺省8022.
    16. sshsrv.rootpwd      指定ROOT用户(容器内)密码,缺省"abc000".
    
    17. inetdail            PPPOE拨号服务配置对象.
    18. inetdail.enable     值为"yes"时指示启用PPPOE拨号服务,缺省"no".
    19. inetdail.dialuser   指定PPPOE拨号用户名称,缺省不使用.
    20. inetdail.dialpswd   指定PPPOE拨号用户密码,缺省不使用.
    21. inetdail.dialintf   指定PPPOE拨号物理接口,缺省自动探测,失败时放弃拨号.
    21. inetdail.usedefgw   值"yes"指示在拨号成功的连接上配置默认路由.
    
###  
    配置数据格式示例(于/srv/imginit/workcfg.json):
        {
          "initdelay": 2,
          "workstart": "DoNothing",
          "workwatch": "0",
          "workintvl": 1,
          "firewall": {
          "tcpportpmt": "8000:8002",
          "udpportpmt": "8000:8002",
          "icmppermit": "yes",
          "igmppermit": "no",
          "grepermit":  "no",
          "esppermit":  "no",
          "ahpermit":   "no"
          },
          "sshsrv": {
            "enable":  "no",
            "sshport": "8022",
            "rootpwd": "abc000"
          },
          "inetdail": {
            "enable":   "no",
            "dialuser": "user00",
            "dialpswd": "passwd00",
            "dialintf": "",
            "usedefgw": "yes"
          }
        }

#### 镜像构建及其它说明

    1. 镜像构建时需要容器具备良好的互联网连接.
    2. 功能程序: inetdial.sh 执行PPPOE拨号管理,位于 /srv/imginit 目录.
    3. 本例中使用的ppp软件包为官方版本上的修改版,添加了插件用于外部认证功能.
    4. 特定的功能和服务可能需要配置适用的容器网络结构和系统权限.
    
    0. 欢迎在功能和性能优化方面多多指教,reamyx@126.com,非常感谢!
